name: Full CI

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  workflow_dispatch:

jobs:
  # Mod 构建任务
  build-mod:
    name: Build Mod
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up JDK 8
      uses: actions/setup-java@v4
      with:
        java-version: '8'
        distribution: 'temurin'

    - name: Set up Gradle 4.9
      uses: gradle/gradle-build-action@v3
      with:
        gradle-version: '4.9'

    - name: Grant execute permission for gradlew
      run: |
        chmod +x gradlew
        cd mod
        chmod +x gradlew

    - name: Build Mod with Gradle
      run: |
        cd mod
        ./gradlew build --no-daemon

    - name: Upload Mod build artifacts
      uses: actions/upload-artifact@v4
      with:
        name: luciddreaming-mod
        path: mod/build/libs/*.jar
        retention-days: 30

  # Android APP 构建任务
  build-android:
    name: Build Android APP
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up JDK 17
      uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'
        cache: 'gradle'

    - name: Setup Gradle
      uses: gradle/gradle-build-action@v3
      with:
        gradle-version: '7.6.3'

    - name: Grant execute permission for gradlew
      run: chmod +x gradlew

    - name: Update settings.gradle.kts for Android build
      run: |
        echo "pluginManagement {" > settings.gradle.kts
        echo "    repositories {" >> settings.gradle.kts
        echo "        google()" >> settings.gradle.kts
        echo "        mavenCentral()" >> settings.gradle.kts
        echo "        gradlePluginPortal()" >> settings.gradle.kts
        echo "    }" >> settings.gradle.kts
        echo "}" >> settings.gradle.kts
        echo "rootProject.name = \"LucidDreaming\"" >> settings.gradle.kts
        echo "include(":shared")" >> settings.gradle.kts
        echo "include(":androidApp")" >> settings.gradle.kts

    - name: Build Android Debug APK
      run: ./gradlew :androidApp:assembleDebug --stacktrace

    - name: Build Android Release APK
      run: ./gradlew :androidApp:assembleRelease --stacktrace

    - name: Upload Debug APK
      uses: actions/upload-artifact@v4
      with:
        name: luciddreaming-android-debug
        path: androidApp/build/outputs/apk/debug/app-debug.apk
        retention-days: 30

    - name: Upload Release APK
      uses: actions/upload-artifact@v4
      with:
        name: luciddreaming-android-release
        path: androidApp/build/outputs/apk/release/app-release-unsigned.apk
        retention-days: 30

    - name: Upload Android Build Reports
      if: failure()
      uses: actions/upload-artifact@v4
      with:
        name: android-build-reports
        path: |
          androidApp/build/reports/
          shared/build/reports/
        retention-days: 7

  # iOS APP 构建任务
  build-ios:
    name: Build iOS APP
    runs-on: macos-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up JDK 17
      uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'
        cache: 'gradle'

    - name: Setup Gradle
      uses: gradle/gradle-build-action@v3
      with:
        gradle-version: '7.6.3'

    - name: Grant execute permission for gradlew
      run: chmod +x gradlew

    - name: Update settings.gradle.kts for iOS build
      run: |
        echo "pluginManagement {" > settings.gradle.kts
        echo "    repositories {" >> settings.gradle.kts
        echo "        google()" >> settings.gradle.kts
        echo "        mavenCentral()" >> settings.gradle.kts
        echo "        gradlePluginPortal()" >> settings.gradle.kts
        echo "    }" >> settings.gradle.kts
        echo "}" >> settings.gradle.kts
        echo "rootProject.name = \"LucidDreaming\"" >> settings.gradle.kts
        echo "include(":shared")" >> settings.gradle.kts
        echo "include(":androidApp")" >> settings.gradle.kts

    - name: Build shared module for iOS
      run: ./gradlew :shared:compileKotlinIosArm64

    - name: Install CocoaPods dependencies
      run: |
        cd iosApp
        pod install

    - name: Build iOS APP
      run: |
        cd iosApp
        xcodebuild -workspace LucidDreaming.xcworkspace -scheme LucidDreaming -destination 'platform=iOS Simulator,name=iPhone 15' build

    - name: Upload iOS Build Reports
      if: failure()
      uses: actions/upload-artifact@v4
      with:
        name: ios-build-reports
        path: iosApp/build/
        retention-days: 7